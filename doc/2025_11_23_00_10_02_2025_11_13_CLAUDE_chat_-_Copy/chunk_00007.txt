Error: {e}\")\n    \n    except Exception as e:\n        logger.error(f\"Error loading data from {path}: {e}\")\n        raise\n\ndef merge_cad_with_reference(cad_df, reference_df, cad_column='Incident', reference_column='Call Type'):\n    \"\"\"\n    Merge CAD data with reference data based on matching columns.\n    \n    Parameters:\n        cad_df (pd.DataFrame): CAD data to enrich\n        reference_df (pd.DataFrame): Reference data with Category_Type and Response columns\n        cad_column (str): Column in cad_df to use for matching\n        reference_column (str): Column in reference_df to use for matching\n    \n    Returns:\n        pd.DataFrame: Merged data with added Category_Type and Response_Type columns\n    \"\"\"\n    # Validate input dataframes\n    if cad_df.empty or reference_df.empty:\n        raise ValueError(\"Input dataframes cannot be empty\")\n    \n    # Validate column names\n    if cad_column not in cad_df.columns:\n        raise ValueError(f\"Column '{cad_column}' not found in CAD data. Available columns: {cad_df.columns.tolist()}\")\n    \n    if reference_column not in reference_df.columns:\n        raise ValueError(f\"Column '{reference_column}' not found in reference data. Available columns: {reference_df.columns.tolist()}\")\n    \n    if 'Category_Type' not in reference_df.columns:\n        logger.warning(\"Column 'Category_Type' not found in reference data. Will be filled with 'Unknown'.\")\n    \n    if 'Response' not in reference_df.columns:\n        logger.warning(\"Column 'Response' not found in reference data. Will be filled with 'Unknown'.\")\n    \n    # Create a copy of the reference dataframe with renamed columns\n    reference_copy = reference_df.copy()\n    \n    # Ensure column names exist in reference data, add empty ones if needed\n    if 'Category_Type' not in reference_copy.columns:\n        reference_copy['Category_Type'] = \"Unknown\"\n    \n    if 'Response' not in reference_copy.columns:\n        reference_copy['Response'] = \"Unknown\"\n    \n    # Rename Response column to Response_Type\n    reference_copy = reference_copy.rename(columns={'Response': 'Response_Type'})\n    \n    # Perform left join\n    merged_df = cad_df.merge(\n        right=reference_copy[[reference_column, 'Category_Type', 'Response_Type']],\n        how='left',\n        left_on=cad_column,\n        right_on=reference_column\n    )\n    \n    # Drop duplicate reference column if it's different from the CAD column\n    if reference_column != cad_column and reference_column in merged_df.columns:\n        merged_df = merged_df.drop(columns=[reference_column])\n    \n    # Fill missing values with \"Unknown\"\n    merged_df['Category_Type'] = merged_df['Category_Type'].fillna(\"Unknown\")\n    merged_df['Response_Type'] = merged_df['Response_Type'].fillna(\"Unknown\")\n    \n    # Log statistics\n    total_rows = len(merged_df)\n    matched_rows = merged_df[merged_df['Category_Type'] != \"Unknown\"].shape[0]\n    match_percentage = (matched_rows / total_rows) * 100 if total_rows > 0 else 0\n    \n    logger.info(f\"Total records: {total_rows}\")\n    logger.info(f\"Matched records: {matched_rows} ({match_percentage:.2f}%)\")\n    logger.info(f\"Unmatched records: {total_rows - matched_rows} ({100 - match_percentage:.2f}%)\")\n    \n    return merged_df\n\ndef save_data(df, output_path):\n    \"\"\"\n    Save dataframe to a file based on the extension.\n    \n    Parameters:\n        df (pd.DataFrame): Data to save\n        output_path (str or Path): Path to save the data\n    \n    Returns:\n        str: Path to the saved file\n    \"\"\"\n    output_path = Path(output_path)\n    \n    try:\n        # Create directory if it doesn't exist\n        output_path.parent.mkdir(parents=True, exist_ok=True)\n        \n        # Save based on extension\n        ext = output_path.suffix.lower()\n        if ext == '.csv':\n            df.to_csv(output_path, index=False)\n        elif ext in ['.xlsx', '.xls']:\n            df.to_excel(output_path, index=False)\n        else:\n            # Default to CSV\n            if not ext:\n                output_path = output_path.with_suffix('.csv')\n            df.to_csv(output_path, index=False)\n        \n        logger.info(f\"Data saved to {output_path}\")\n        return str(output_path)\n    \n    except Exception as e:\n        logger.error(f\"Error saving data to {output_path}: {e}\")\n        raise\n\ndef main():\n    \"\"\"Main function to run the script from command line.\"\"\"\n    parser = argparse.ArgumentParser(description=\"Enrich CAD data with Category_Type and Response_Type\")\n    parser.add_argument('--cad-file', required=True, help='Path to the cleaned CAD export CSV file')\n    parser.add_argument('--reference-file', required=True, help='Path to the reference file with Call Type, Category_Type, and Response columns')\n    parser.add_argument('--output', default='CAD_Master_Merged.csv', help='Output file path (default: CAD_Master_Merged.csv)')\n    parser.add_argument('--cad-column', default='Incident', help='Column name in CAD file to match (default: Incident)')\n    parser.add_argument('--reference-column', default='Call Type', help='Column name in reference file to match (default: Call Type)')\n    \n    args = parser.parse_args()\n    \n    try:\n        # Load data\n        logger.info(f\"Loading CAD data from {args.cad_file}\")\n        cad_df = load_data(args.cad_file)\n        \n        logger.info(f\"Loading reference data from {args.reference_file}\")\n        reference_df = load_data(args.reference_file)\n        \n        # Merge data\n        logger.info(f\"Merging data on {args.cad_column} = {args.reference_column}\")\n        merged_df = merge_cad_with_reference(\n            cad_df, \n            reference_df,\n            cad_column=args.cad_column,\n            reference_column=args.reference_column\n        )\n        \n        # Save result\n        output_path = args.output\n        if not os.path.isabs(output_path):\n            # If relative path, save in the same directory as the CAD file\n            cad_dir = os.path.dirname(os.path.abspath(args.cad_file))\n            output_path = os.path.join(cad_dir, output_path)\n        \n        logger.info(f\"Saving enriched data to {output_path}\")\n        save_data(merged_df, output_path)\n        \n        logger.info(\"Data enrichment completed successfully\")\n        \n    except Exception as e:\n        logger.error(f\"Error during data enrichment: {e}\")\n        return 1\n    \n    return 0\n\nif __name__ == \"__main__\":\n    exit(main())\n",
          "description": "Creating a Python script to merge CAD data with the reference file"
        },
        "message": "Creating a Python script to merge CAD data with the reference file",
        "display_content": {
          "type": "json_block",
          "json_block": "{\"language\": \"python\", \"code\": \"#!/usr/bin/env python3\\n# 2025-11-14-03-17-45\\n# CAD_Data_Cleaning_Engine/cad_data_enricher.py\\n# Author: R. A. Carucci\\n# Purpose: Enrich CAD data with Category_Type and Response_Type by merging with a reference file\\n\\nimport os\\nimport pandas as pd\\nimport argparse\\nfrom pathlib import Path\\nimport logging\\n\\n# Set up logging\\nlogging.basicConfig(\\n    level=logging.INFO,\\n    format='%(asctime)s - %(levelname)s - %(message)s'\\n)\\nlogger = logging.getLogger(__name__)\\n\\ndef load_data(file_path, file_type=None):\\n    \\\"\\\"\\\"\\n    Load data from a file based on its extension or specified type.\\n    \\n    Parameters:\\n        file_path (str or Path): Path to the data file\\n        file_type (str, optional): Force a specific file type ('csv', 'excel', 'tsv')\\n    \\n    Returns:\\n        pd.DataFrame: Loaded data\\n    \\\"\\\"\\\"\\n    path = Path(file_path)\\n    \\n    if not path.exists():\\n        raise FileNotFoundError(f\\\"File not found: {path}\\\")\\n    \\n    # Determine file type\\n    if file_type:\\n        file_ext = file_type.lower()\\n    else:\\n        file_ext = path.suffix.lower()\\n    \\n    try:\\n        # Load based on file type\\n        if file_ext in ['.xlsx', '.xls'] or file_type == 'excel':\\n            return pd.read_excel(path)\\n        elif file_ext == '.csv' or file_type == 'csv':\\n            return pd.read_csv(path)\\n        elif file_ext == '.tsv' or file_type == 'tsv':\\n            return pd.read_csv(path, sep='\\\\t')\\n        else:\\n            # Try to guess the format\\n            try:\\n                return pd.read_csv(path)\\n            except:\\n                try:\\n                    return pd.read_csv(path, sep='\\\\t')\\n                except:\\n                    try:\\n                        return pd.read_excel(path)\\n                    except Exception as e:\\n                        raise ValueError(f\\\"Could not determine file format for {path}. Error: {e}\\\")\\n    \\n    except Exception as e:\\n        logger.error(f\\\"Error loading data from {path}: {e}\\\")\\n        raise\\n\\ndef merge_cad_with_reference(cad_df, reference_df, cad_column='Incident', reference_column='Call Type'):\\n    \\\"\\\"\\\"\\n    Merge CAD data with reference data based on matching columns.\\n    \\n    Parameters:\\n        cad_df (pd.DataFrame): CAD data to enrich\\n        reference_df (pd.DataFrame): Reference data with Category_Type and Response columns\\n        cad_column (str): Column in cad_df to use for matching\\n        reference_column (str): Column in reference_df to use for matching\\n    \\n    Returns:\\n        pd.DataFrame: Merged data with added Category_Type and Response_Type columns\\n    \\\"\\\"\\\"\\n    # Validate input dataframes\\n    if cad_df.empty or reference_df.empty:\\n        raise ValueError(\\\"Input dataframes cannot be empty\\\")\\n    \\n    # Validate column names\\n    if cad_column not in cad_df.columns:\\n        raise ValueError(f\\\"Column '{cad_column}' not found in CAD data. Available columns: {cad_df.columns.tolist()}\\\")\\n    \\n    if reference_column not in reference_df.columns:\\n        raise ValueError(f\\\"Column '{reference_column}' not found in reference data. Available columns: {reference_df.columns.tolist()}\\\")\\n    \\n    if 'Category_Type' not in reference_df.columns:\\n        logger.warning(\\\"Column 'Category_Type' not found in reference data. Will be filled with 'Unknown'.\\\")\\n    \\n    if 'Response' not in reference_df.columns:\\n        logger.warning(\\\"Column 'Response' not found in reference data.